databases:
  augur:
    dsn: !env AUGUR_DSN
    # user: !env AUGUR_DB_USER
    # password: !env AUGUR_DB_PASSWORD

metrics:
  augur_collection_status_counts:
    type: gauge
    labels: [collection_state, collection_phase]
    description: Number of repositories in each different state for each phase of collection.
  augur_never_collected_counts:
    type: gauge
    labels: [collection_phase]
    description: Number of repositories in each different state for each phase of collection that have never had collection.
  augur_repos_currently_collecting:
    type: gauge
    description: Number of repositories currently in the 'Collecting' status, categorized by collection stage.
    labels: [collection_stage]
  augur_core_collected_recently_count:
    type: gauge
    description: Count of repos where core data was collected after a recent threshold (e.g., last 30 days).

queries:
  collection_status_counts:
    interval: 30
    databases: [augur]
    metrics: [augur_collection_status_counts]
    sql: |
      SELECT
          collection_phase,
          collection_state,
          COALESCE(count, 0) AS augur_collection_status_counts
      FROM (
          SELECT 'core' AS collection_phase, unnest(ARRAY['Pending', 'Error', 'Success', 'Ignore']) AS collection_state
          UNION ALL
          SELECT 'secondary' AS collection_phase, unnest(ARRAY['Pending', 'Error', 'Success', 'Ignore']) AS collection_state
          UNION ALL
          SELECT 'facade' AS collection_phase, unnest(ARRAY['Pending', 'Error', 'Success', 'Ignore']) AS collection_state
      ) AS status_combinations
      LEFT JOIN (
          SELECT
              'core' AS collection_phase, core_status AS collection_state, COUNT(*) as count
          FROM augur_operations.collection_status
          WHERE core_status IN ('Pending', 'Error', 'Success', 'Ignore')
          GROUP BY 1, 2
          UNION ALL
          SELECT
              'secondary' AS collection_phase, secondary_status AS collection_state, COUNT(*) as count
          FROM augur_operations.collection_status
          WHERE secondary_status IN ('Pending', 'Error', 'Success', 'Ignore')
          GROUP BY 1, 2
          UNION ALL
          SELECT
              'facade' AS collection_phase, facade_status AS collection_state, COUNT(*) as count 
          FROM augur_operations.collection_status
          WHERE facade_status IN ('Pending', 'Error', 'Success', 'Ignore')
          GROUP BY 1, 2
      ) AS actual_counts
      USING (collection_phase, collection_state)
      ORDER BY collection_phase, collection_state;
  never_collected_counts:
    interval: 30
    databases: [augur]
    metrics: [augur_never_collected_counts]
    sql: |
      SELECT
          collection_phase,
          COALESCE(count, 0) AS augur_never_collected_counts
      FROM (
          SELECT 'core' AS collection_phase
          UNION ALL
          SELECT 'secondary' AS collection_phase
          UNION ALL
          SELECT 'facade' AS collection_phase
      ) AS status_combinations
      LEFT JOIN (
          SELECT
              'core' AS collection_phase, COUNT(*) as count
          FROM augur_operations.collection_status
          WHERE core_data_last_collected IS NULL
          UNION ALL
          SELECT
              'secondary' AS collection_phase, COUNT(*) as count
          FROM augur_operations.collection_status
          WHERE secondary_data_last_collected IS NULL
          UNION ALL
          SELECT
              'facade' AS collection_phase, COUNT(*) as count 
          FROM augur_operations.collection_status
          WHERE facade_data_last_collected IS NULL
      ) AS actual_counts
      USING (collection_phase)
      ORDER BY collection_phase;
  active_collection:
    interval: 15
    databases: [augur]
    metrics: [augur_repos_currently_collecting]
    sql: |
      SELECT 'core' AS collection_stage, COUNT(*) AS augur_repos_currently_collecting
      FROM augur_operations.collection_status
      WHERE core_status = 'Collecting'
      UNION ALL
      SELECT 'secondary' AS collection_stage, COUNT(*) AS augur_repos_currently_collecting
      FROM augur_operations.collection_status
      WHERE secondary_status = 'Collecting'
      UNION ALL
      SELECT 'facade' AS collection_stage, COUNT(*) AS augur_repos_currently_collecting
      FROM augur_operations.collection_status
      WHERE facade_status = 'Collecting';
  recency_check:
    interval: 300 # Less frequent check
    databases: [augur]
    metrics: [augur_core_collected_recently_count]
    sql: |
      SELECT COUNT(*) AS augur_core_collected_recently_count
      FROM augur_operations.collection_status
      WHERE core_data_last_collected > now() - interval '30 day'; -- Using a rolling window